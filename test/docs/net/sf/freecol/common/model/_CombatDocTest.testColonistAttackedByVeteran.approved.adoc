ifndef::ROOT_PATH[:ROOT_PATH: ../../../../..]
ifndef::RESOURCES_PATH[:RESOURCES_PATH: {ROOT_PATH}/../../data/rules/classic]

[#net_sf_freecol_common_model_combatdoctest_testcolonistattackedbyveteran]
= TestColonistAttackedByVeteran

.Initial test code

[source,java,indent=0]
----
    public void testColonistAttackedByVeteran() throws Exception {
        Game game = getStandardGame();
        Map map = getTestMap(plains);
        game.changeMap(map);

        CombatModel combatModel = game.getCombatModel();
        Player dutch = game.getPlayerByNationId("model.nation.dutch");
        Player french = game.getPlayerByNationId("model.nation.french");
        FreeColTestCase.spec();
        Tile tile1 = map.getTile(5, 8);
        tile1.setType(hills);
        assertEquals(hills, tile1.getType());
        tile1.setExplored(dutch, true);
        tile1.setExplored(french, true);
        Tile tile2 = map.getTile(4, 8);
        tile2.setExplored(dutch, true);
        tile2.setExplored(french, true);

        Unit colonist = new ServerUnit(game, tile1, dutch, colonistType);
        colonist.setStateUnchecked(Unit.UnitState.FORTIFIED);
        Unit soldier = new ServerUnit(game, tile2, french,
                                      veteranType, dragoonRole);
        soldier.setMovesLeft(1);
        assertFalse(soldier.hasAbility(Ability.AMBUSH_BONUS));
        assertFalse(colonist.hasAbility(Ability.AMBUSH_PENALTY));

        final Modifier bigMovementPenalty
            = first(spec().getModifiers(Modifier.BIG_MOVEMENT_PENALTY));
        final Modifier attackModifier
            = first(spec().getModifiers(Modifier.ATTACK_BONUS));
        final List<Modifier> veteranModifiers
            = toList(veteranType.getModifiers(Modifier.OFFENCE));
        assertEquals(1, veteranModifiers.size());
        final Modifier veteranModifier = first(veteranModifiers);

        Set<Modifier> offenceModifiers
            = combatModel.getOffensiveModifiers(soldier, colonist);
        assertEquals(5, offenceModifiers.size());
        int n = 0;
        for (Modifier m : offenceModifiers) {
            if (m.getSource() == Specification.BASE_OFFENCE_SOURCE) n += 1;
            if (m == bigMovementPenalty) n += 2;
            if (m == attackModifier) n += 4;
            if (m == veteranModifier) n += 8;
            if (m.getSource() == dragoonRole) n += 16;
        }
        assertEquals(31, n);

        final Modifier fortifiedModifier
            = first(spec().getModifiers(Modifier.FORTIFIED));
        final List<Modifier> hillsModifiers = toList(hills.getDefenceModifiers());
        assertEquals(1, hillsModifiers.size());
        Modifier hillsModifier = first(hillsModifiers);

        Set<Modifier> defenceModifiers
            = combatModel.getDefensiveModifiers(soldier, colonist);
        assertEquals(3, defenceModifiers.size());
        assertTrue(defenceModifiers.contains(fortifiedModifier));
        defenceModifiers.remove(fortifiedModifier);
        assertTrue(defenceModifiers.contains(hillsModifier));
        defenceModifiers.remove(hillsModifier);
        // this was also added by the combat model
        assertEquals(Specification.BASE_DEFENCE_SOURCE,
            first(defenceModifiers).getSource());
    }
----
